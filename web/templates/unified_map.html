<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SecuringSkies | Unified Commander</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.114.0/Cesium.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.114.0/Widgets/widgets.min.css" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        body { margin: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* LAYOUT FIX: display:none ensures 3D is HIDDEN by default */
        #map-2d { height: 100vh; width: 100vw; position: absolute; top:0; left:0; z-index: 10; display: block; }
        #map-3d { height: 100vh; width: 100vw; position: absolute; top:0; left:0; z-index: 5; display: none; }
        
        #hud {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); padding: 15px; 
            border: 1px solid #00ff00; border-radius: 5px; 
            min-width: 250px; color: #0f0;
        }
        
        #toggle-btn {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: #004400; color: #0f0; border: 1px solid #0f0;
            padding: 10px 20px; font-family: 'Courier New', monospace;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        #toggle-btn:hover { background: #006600; }

        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleView()">SWITCH TO 3D</button>

    <div id="hud">
        <b>ðŸ¦… GHOST COMMANDER</b><br>
        MODE: <span id="view-mode">2D TACTICAL</span><br>
        STATUS: <span id="status" style="color:#888">CONNECTING...</span>
        <hr style="border-color:#040">
        <div id="asset-list">Waiting for telemetry...</div>
    </div>

    <div id="map-2d"></div>
    <div id="map-3d"></div>

    <script>
        let currentMode = '2D';
        let cesiumInitialized = false;
        const assets = {};

        // --- 1. INITIALIZE 2D MAP (Immediate) ---
        const map2D = L.map('map-2d').setView([60.2, 24.5], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map2D);
        const markers2D = {};

        // --- 2. TOGGLE LOGIC ---
        function toggleView() {
            const btn = document.getElementById('toggle-btn');
            const viewLabel = document.getElementById('view-mode');
            const div2D = document.getElementById('map-2d');
            const div3D = document.getElementById('map-3d');

            if (currentMode === '2D') {
                // Switch to 3D
                currentMode = '3D';
                div2D.style.display = 'none';
                div3D.style.display = 'block';
                btn.innerText = "SWITCH TO 2D";
                viewLabel.innerText = "3D GLOBE";
                
                if (!cesiumInitialized) initCesium();
            } else {
                // Switch to 2D
                currentMode = '2D';
                div3D.style.display = 'none';
                div2D.style.display = 'block';
                btn.innerText = "SWITCH TO 3D";
                viewLabel.innerText = "2D TACTICAL";
            }
        }

        // --- 3. INITIALIZE 3D MAP ---
        function initCesium() {
            try {
                // INJECT TOKEN SECURELY
                const token = '{{ cesium_token }}';
                Cesium.Ion.defaultAccessToken = token;

                window.viewer = new Cesium.Viewer('map-3d', {
                    imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }), // Satellite
                    terrainProvider: undefined, // Disable Terrain (Fixes Black Screen issues)
                    baseLayerPicker: false, timeline: false, animation: false,
                    homeButton: false, sceneModePicker: false, navigationHelpButton: false, 
                    geocoder: false, selectionIndicator: false, infoBox: false
                });

                window.viewer.cesiumWidget.creditContainer.style.display = "none";
                cesiumInitialized = true;

                // Force Camera to Finland
                window.viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(24.5, 60.2, 50000), 
                    orientation: { heading: 0, pitch: Cesium.Math.toRadians(-90), roll: 0 }
                });

                // Try Buildings
                try {
                    const b = window.viewer.scene.primitives.add(Cesium.createOsmBuildings());
                    b.style = new Cesium.Cesium3DTileStyle({
                        color: { conditions: [['true', 'color("cyan", 0.5)']] }
                    });
                } catch(e) {}

            } catch (e) {
                alert("3D Init Failed: " + e);
            }
        }

        // --- 4. NETWORK & DATA HANDLER ---
        const socket = io({transports: ['websocket', 'polling']});

        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').style.color = "#00ff00";
        });

        socket.on('update', (data) => {
            const { tid, lat, lon, alt, icon } = data;
            
            assets[tid] = { icon, lastSeen: new Date() };
            updateHUD();
            update2D(tid, lat, lon, icon);

            if (cesiumInitialized && window.viewer) {
                update3D(tid, lat, lon, alt, icon);
            }
        });

        function update2D(tid, lat, lon, icon) {
            let color = '#fff';
            if (icon === 'mobile') color = '#3388ff';
            if (icon === 'plane') color = '#ff3333';
            if (icon === 'helicopter') color = '#ffaa33';

            const popup = `<b>${tid}</b><br>${icon.toUpperCase()}`;

            if (markers2D[tid]) {
                markers2D[tid].setLatLng([lat, lon]).setPopupContent(popup);
            } else {
                markers2D[tid] = L.circleMarker([lat, lon], {
                    color: color, fillColor: color, fillOpacity: 0.9, radius: 10
                }).addTo(map2D).bindPopup(popup);
            }
        }

        function update3D(tid, lat, lon, alt, icon) {
            let color = Cesium.Color.WHITE;
            if (icon === 'mobile') color = Cesium.Color.DODGERBLUE;
            if (icon === 'plane') color = Cesium.Color.RED;
            if (icon === 'helicopter') color = Cesium.Color.ORANGE;

            let entity = window.viewer.entities.getById(tid);
            if (!entity) {
                entity = window.viewer.entities.add({
                    id: tid,
                    position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                    point: { pixelSize: 15, color: color, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                    label: { text: tid, font: '12pt monospace', style: Cesium.LabelStyle.FILL_AND_OUTLINE, pixelOffset: new Cesium.Cartesian2(0, -20) },
                    polyline: { 
                        positions: new Cesium.CallbackProperty(() => [
                            Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                            Cesium.Cartesian3.fromDegrees(lon, lat, 0)
                        ], false), 
                        width: 2, material: color 
                    }
                });
            } else {
                entity.position = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
            }
        }

        function updateHUD() {
            const list = document.getElementById('asset-list');
            list.innerHTML = Object.keys(assets).map(tid => {
                let c = '#fff';
                if(assets[tid].icon == 'mobile') c = '#3388ff';
                if(assets[tid].icon == 'plane') c = '#ff3333';
                if(assets[tid].icon == 'helicopter') c = '#ffaa33';
                return `<div style="margin-top:5px"><span class="dot" style="background:${c}"></span> ${tid}</div>`;
            }).join('');
        }
    </script>
</body>
</html>
