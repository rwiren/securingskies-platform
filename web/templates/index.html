<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SecuringSkies | 2D Tactical Grid</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #0f0f0f; color: #00ff00; font-family: 'Courier New', monospace; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        #hud {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); padding: 15px; 
            border: 1px solid #00ff00; border-radius: 5px; 
            min-width: 200px;
        }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>

    <div id="hud">
        <b>ðŸ¦… TACTICAL FEED</b><br>
        STATUS: <span id="status" style="color:#888">CONNECTING...</span>
        <hr style="border-color:#040">
        <div id="asset-list">Waiting for data...</div>
    </div>

    <div id="map"></div>

    <script>
        // 1. MAP SETUP (Dark Mode, No Token Required)
        const map = L.map('map').setView([60.2, 24.5], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map);

        // 2. NETWORK
        const socket = io({transports: ['websocket', 'polling']});
        const markers = {};

        socket.on('connect', () => {
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').style.color = "#00ff00";
        });

        socket.on('update', (data) => {
            const { tid, lat, lon, icon } = data;
            
            let color = '#ffffff';
            if (icon === 'mobile')     color = '#3388ff';
            if (icon === 'plane')      color = '#ff3333';
            if (icon === 'helicopter') color = '#ffaa33';
            if (icon === 'controller') color = '#00ffff';

            if (markers[tid]) {
                markers[tid].setLatLng([lat, lon]);
                markers[tid].setStyle({color: color, fillColor: color});
            } else {
                markers[tid] = L.circleMarker([lat, lon], {
                    color: color, fillColor: color, fillOpacity: 0.8, radius: 8
                }).addTo(map).bindPopup(`<b>${tid}</b>`);
            }
            updateHUD();
        });

        function updateHUD() {
            const keys = Object.keys(markers);
            const list = document.getElementById('asset-list');
            if (keys.length === 0) { list.innerHTML = "Scanning..."; return; }
            list.innerHTML = keys.map(tid => {
                const color = markers[tid].options.color;
                return `<div><span class="dot" style="background:${color}"></span> ${tid}</div>`;
            }).join('');
        }
    </script>
</body>
</html>
